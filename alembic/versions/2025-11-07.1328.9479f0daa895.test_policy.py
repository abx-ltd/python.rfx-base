"""test policy

Revision ID: 9479f0daa895
Revises: e904b5c41b59
Create Date: 2025-11-07 13:28:37.241171

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from alembic_utils.pg_view import PGView
from sqlalchemy import text as sql_text

# revision identifiers, used by Alembic.
revision: str = '9479f0daa895'
down_revision: Union[str, Sequence[str], None] = 'e904b5c41b59'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('policy',
    sa.Column('key', sa.String(length=255), nullable=False),
    sa.Column('display', sa.String(length=255), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('priority', sa.Integer(), nullable=True),
    sa.Column('effect', sa.Enum('ALLOW', 'DENY', name='policyeffectenum', schema='rfx_policy_test'), nullable=True),
    sa.Column('status', sa.Enum('ENABLED', 'DISABLED', name='policystatusenum', schema='rfx_policy_test'), nullable=True),
    sa.Column('scope', sa.Enum('SYSTEM', 'PUBLIC', name='policyscopeenum', schema='rfx_policy_test'), nullable=True),
    sa.Column('kind', sa.Enum('CUSTOM', 'SYSTEM', 'STATIC', name='policykindenum', schema='rfx_policy_test'), nullable=True),
    sa.Column('_realm', sa.String(length=255), nullable=True),
    sa.Column('_id', sa.UUID(), server_default=sa.text('uuid_generate_v4()'), nullable=False),
    sa.Column('_created', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('_updated', sa.DateTime(timezone=True), nullable=True),
    sa.Column('_creator', sa.UUID(), nullable=True),
    sa.Column('_updater', sa.UUID(), nullable=True),
    sa.Column('_deleted', sa.DateTime(timezone=True), nullable=True),
    sa.Column('_etag', sa.String(length=64), server_default=sa.text('uuid_generate_v4()::varchar'), nullable=True),
    sa.PrimaryKeyConstraint('_id'),
    sa.UniqueConstraint('key'),
    schema='rfx_policy_test'
    )
    op.create_table('policy_resource',
    sa.Column('key', sa.String(length=255), nullable=True),
    sa.Column('name', sa.String(length=255), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('priority', sa.Integer(), nullable=True),
    sa.Column('effect', sa.Enum('ALLOW', 'DENY', name='policyeffectenum', schema='rfx_policy_test'), nullable=True),
    sa.Column('status', sa.Enum('ENABLED', 'DISABLED', name='policystatusenum', schema='rfx_policy_test'), nullable=True),
    sa.Column('scope', sa.Enum('SYSTEM', 'PUBLIC', name='policyscopeenum', schema='rfx_policy_test'), nullable=True),
    sa.Column('kind', sa.Enum('CUSTOM', 'SYSTEM', 'STATIC', name='policykindenum', schema='rfx_policy_test'), nullable=True),
    sa.Column('cqrs', sa.Enum('COMMAND', 'QUERY', name='policycqrsenum', schema='rfx_policy_test'), nullable=True),
    sa.Column('domain', sa.String(length=255), nullable=True),
    sa.Column('action', sa.String(length=255), nullable=True),
    sa.Column('resource', sa.String(length=255), nullable=True),
    sa.Column('policy_key', sa.String(length=255), nullable=False),
    sa.Column('meta', sa.Text(), nullable=True),
    sa.Column('_realm', sa.String(length=255), nullable=True),
    sa.Column('_id', sa.UUID(), server_default=sa.text('uuid_generate_v4()'), nullable=False),
    sa.Column('_created', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('_updated', sa.DateTime(timezone=True), nullable=True),
    sa.Column('_creator', sa.UUID(), nullable=True),
    sa.Column('_updater', sa.UUID(), nullable=True),
    sa.Column('_deleted', sa.DateTime(timezone=True), nullable=True),
    sa.Column('_etag', sa.String(length=64), server_default=sa.text('uuid_generate_v4()::varchar'), nullable=True),
    sa.ForeignKeyConstraint(['policy_key'], ['rfx_policy_test.policy.key'], ),
    sa.PrimaryKeyConstraint('_id'),
    schema='rfx_policy_test'
    )
    op.create_table('policy_role',
    sa.Column('policy_key', sa.String(length=255), nullable=False),
    sa.Column('role_key', sa.String(length=255), nullable=True),
    sa.Column('_realm', sa.String(length=255), nullable=True),
    sa.Column('_id', sa.UUID(), server_default=sa.text('uuid_generate_v4()'), nullable=False),
    sa.Column('_created', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('_updated', sa.DateTime(timezone=True), nullable=True),
    sa.Column('_creator', sa.UUID(), nullable=True),
    sa.Column('_updater', sa.UUID(), nullable=True),
    sa.Column('_deleted', sa.DateTime(timezone=True), nullable=True),
    sa.Column('_etag', sa.String(length=64), server_default=sa.text('uuid_generate_v4()::varchar'), nullable=True),
    sa.ForeignKeyConstraint(['policy_key'], ['rfx_policy_test.policy.key'], ),
    sa.PrimaryKeyConstraint('_id'),
    schema='rfx_policy_test'
    )
    rfx_policy_test__policy__user_profile = PGView(
        schema="rfx_policy_test",
        signature="_policy__user_profile",
        definition='SELECT uuid_generate_v4() AS _id,\n    \'p\'::character varying(255) AS ptype,\n    pol_rol.role_key AS role,\n    NULL::character varying(255) AS sub,\n    NULL::character varying(255) AS org,\n    pol_res.domain AS dom,\n    pol_res.resource AS res,\n    NULL::character varying(255) AS rid,\n    pol_res.action AS act,\n    pol_res.cqrs::character varying(255) AS cqrs,\n    concat_ws(\'\'::text, pol_res.meta)::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_policy.policy_role pol_rol\n     JOIN rfx_policy.policy_resource pol_res ON pol_rol.policy_key::text = pol_res.policy_key::text\n  WHERE pol_res.domain::text = \'user-profile\'::text\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g\'::character varying(255) AS ptype,\n    pro_rol.role_key AS role,\n    profile._id::character varying(255) AS sub,\n    profile.organization_id::character varying(255) AS org,\n    NULL::character varying(255) AS dom,\n    NULL::character varying(255) AS res,\n    NULL::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user.profile\n     JOIN rfx_user.profile_role pro_rol ON profile._id = pro_rol.profile_id\n  WHERE pro_rol._deleted IS NULL\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g2\'::character varying(255) AS ptype,\n    NULL::character varying(255) AS role,\n    NULL::character varying(255) AS sub,\n    organization._id::character varying(255) AS org,\n    \'user-profile\'::character varying(255) AS dom,\n    \'organization\'::character varying(255) AS res,\n    organization._id::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user.organization\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g2\'::character varying(255) AS ptype,\n    NULL::character varying(255) AS role,\n    NULL::character varying(255) AS sub,\n    invitation.organization_id::character varying(255) AS org,\n    \'user-profile\'::character varying(255) AS dom,\n    \'invitation\'::character varying(255) AS res,\n    invitation._id::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user.invitation\n  WHERE invitation.organization_id IS NOT NULL\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g2\'::character varying(255) AS ptype,\n    NULL::character varying(255) AS role,\n    NULL::character varying(255) AS sub,\n    profile.organization_id::character varying(255) AS org,\n    \'user-profile\'::character varying(255) AS dom,\n    \'profile\'::character varying(255) AS res,\n    profile._id::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user.profile\n  WHERE profile.organization_id IS NOT NULL\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g2\'::character varying(255) AS ptype,\n    NULL::character varying(255) AS role,\n    NULL::character varying(255) AS sub,\n    "group".resource_id::character varying(255) AS org,\n    \'user-profile\'::character varying(255) AS dom,\n    \'group\'::character varying(255) AS res,\n    "group"._id::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user."group"\n  WHERE "group".resource_id IS NOT NULL AND "group".resource::text = \'organization\'::text\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g3\'::character varying(255) AS ptype,\n    \'self-access\'::character varying(255) AS role,\n    "user"._id::character varying(255) AS sub,\n    NULL::character varying(255) AS org,\n    NULL::character varying(255) AS dom,\n    NULL::character varying(255) AS res,\n    NULL::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user."user"\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g4\'::character varying(255) AS ptype,\n    NULL::character varying(255) AS role,\n    "user"._id::character varying(255) AS sub,\n    NULL::character varying(255) AS org,\n    \'user-profile\'::character varying(255) AS dom,\n    \'user\'::character varying(255) AS res,\n    "user"._id::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user."user"\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g4\'::character varying(255) AS ptype,\n    NULL::character varying(255) AS role,\n    profile.user_id::character varying(255) AS sub,\n    NULL::character varying(255) AS org,\n    \'user-profile\'::character varying(255) AS dom,\n    \'profile\'::character varying(255) AS res,\n    profile._id::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user.profile'
    )
    op.create_entity(rfx_policy_test__policy__user_profile)

    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    rfx_policy_test__policy__user_profile = PGView(
        schema="rfx_policy_test",
        signature="_policy__user_profile",
        definition='SELECT uuid_generate_v4() AS _id,\n    \'p\'::character varying(255) AS ptype,\n    pol_rol.role_key AS role,\n    NULL::character varying(255) AS sub,\n    NULL::character varying(255) AS org,\n    pol_res.domain AS dom,\n    pol_res.resource AS res,\n    NULL::character varying(255) AS rid,\n    pol_res.action AS act,\n    pol_res.cqrs::character varying(255) AS cqrs,\n    concat_ws(\'\'::text, pol_res.meta)::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_policy.policy_role pol_rol\n     JOIN rfx_policy.policy_resource pol_res ON pol_rol.policy_key::text = pol_res.policy_key::text\n  WHERE pol_res.domain::text = \'user-profile\'::text\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g\'::character varying(255) AS ptype,\n    pro_rol.role_key AS role,\n    profile._id::character varying(255) AS sub,\n    profile.organization_id::character varying(255) AS org,\n    NULL::character varying(255) AS dom,\n    NULL::character varying(255) AS res,\n    NULL::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user.profile\n     JOIN rfx_user.profile_role pro_rol ON profile._id = pro_rol.profile_id\n  WHERE pro_rol._deleted IS NULL\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g2\'::character varying(255) AS ptype,\n    NULL::character varying(255) AS role,\n    NULL::character varying(255) AS sub,\n    organization._id::character varying(255) AS org,\n    \'user-profile\'::character varying(255) AS dom,\n    \'organization\'::character varying(255) AS res,\n    organization._id::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user.organization\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g2\'::character varying(255) AS ptype,\n    NULL::character varying(255) AS role,\n    NULL::character varying(255) AS sub,\n    invitation.organization_id::character varying(255) AS org,\n    \'user-profile\'::character varying(255) AS dom,\n    \'invitation\'::character varying(255) AS res,\n    invitation._id::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user.invitation\n  WHERE invitation.organization_id IS NOT NULL\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g2\'::character varying(255) AS ptype,\n    NULL::character varying(255) AS role,\n    NULL::character varying(255) AS sub,\n    profile.organization_id::character varying(255) AS org,\n    \'user-profile\'::character varying(255) AS dom,\n    \'profile\'::character varying(255) AS res,\n    profile._id::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user.profile\n  WHERE profile.organization_id IS NOT NULL\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g2\'::character varying(255) AS ptype,\n    NULL::character varying(255) AS role,\n    NULL::character varying(255) AS sub,\n    "group".resource_id::character varying(255) AS org,\n    \'user-profile\'::character varying(255) AS dom,\n    \'group\'::character varying(255) AS res,\n    "group"._id::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user."group"\n  WHERE "group".resource_id IS NOT NULL AND "group".resource::text = \'organization\'::text\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g3\'::character varying(255) AS ptype,\n    \'self-access\'::character varying(255) AS role,\n    "user"._id::character varying(255) AS sub,\n    NULL::character varying(255) AS org,\n    NULL::character varying(255) AS dom,\n    NULL::character varying(255) AS res,\n    NULL::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user."user"\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g4\'::character varying(255) AS ptype,\n    NULL::character varying(255) AS role,\n    "user"._id::character varying(255) AS sub,\n    NULL::character varying(255) AS org,\n    \'user-profile\'::character varying(255) AS dom,\n    \'user\'::character varying(255) AS res,\n    "user"._id::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user."user"\nUNION ALL\n SELECT uuid_generate_v4() AS _id,\n    \'g4\'::character varying(255) AS ptype,\n    NULL::character varying(255) AS role,\n    profile.user_id::character varying(255) AS sub,\n    NULL::character varying(255) AS org,\n    \'user-profile\'::character varying(255) AS dom,\n    \'profile\'::character varying(255) AS res,\n    profile._id::character varying(255) AS rid,\n    NULL::character varying(255) AS act,\n    NULL::character varying(255) AS cqrs,\n    NULL::character varying(255) AS meta,\n    NULL::timestamp without time zone AS _deleted\n   FROM rfx_user.profile'
    )
    op.drop_entity(rfx_policy_test__policy__user_profile)

    op.drop_table('policy_role', schema='rfx_policy_test')
    op.drop_table('policy_resource', schema='rfx_policy_test')
    op.drop_table('policy', schema='rfx_policy_test')
    # ### end Alembic commands ###
